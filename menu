#!/bin/bash

# ===== COLORS =====
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[93m"
CYAN="\e[36m"
CYAN_BRIGHT="\e[96m"
YELLOW_BRIGHT="\e[93m"
BOLD="\e[1m"
RESET="\e[0m"
Register="\e[0m"   # Tambahan biar ${Register} valid

# ===== PASTIKAN DIJALANKAN ROOT =====
if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}Please run the command with root privileges!${Register}"
    exit 1
fi

# ===== CEK IP TERDAFTAR =====
MYIP=$(curl -4 -s icanhazip.com)
line=$(curl -s https://raw.githubusercontent.com/Pemulaajiw/script/main/register| grep "$MYIP")

if [ -z "$line" ]; then
    echo -e "${RED}IP $MYIP tidak terdaftar di Register!${Register}"
    echo -e "${YELLOW}Mohon hubungi admin untuk registrasi.${Register}"
    exit 1
fi

# Ambil username, expired, dan IP
username=$(echo "$line" | awk '{print $2}')
expired=$(echo "$line" | awk '{print $3}')
ip=$(echo "$line" | awk '{print $4}')

# ===== HITUNG SISA HARI =====
today=$(date +%Y-%m-%d)
expiry_date="$expired"
today_sec=$(date -d "$today" +%s)
expiry_sec=$(date -d "$expiry_date" +%s)
diff_sec=$(( expiry_sec - today_sec ))
diff_days=$(( (diff_sec / 86400) + 1 ))

if [[ $diff_days -lt 0 ]]; then
    echo -e "${RED}User $username sudah expired pada $expired!${Register}"
    echo -e "${YELLOW}Mohon perpanjang akses terlebih dahulu.${Register}"
    exit 1
fi

# ===== BERIKAN IZIN EKSEKUSI OTOMATIS =====
SYSTEM_DIR="/etc/Sslablk/system"
if [ -d "$SYSTEM_DIR" ]; then
    chmod +x "$SYSTEM_DIR"/*.sh
    echo -e "${GREEN}All scripts in $SYSTEM_DIR are now executable.${Register}"
    sleep 1
else
    echo -e "${RED}System directory $SYSTEM_DIR not found!${Register}"
    exit 1
fi

# ===== HITUNG TOTAL USER =====
total_user() {
    awk -F: '$3 >= 1000 {print $1}' /etc/passwd | grep -v nobody | wc -l
}

# ===== AMBIL HOST =====
get_host() {
    HOST_FILE="/root/udp/host.conf"
    if [ -f "$HOST_FILE" ]; then
        cat "$HOST_FILE"
    else
        echo "Host file not found"
    fi
}

# ===== FUNGSI MENU =====
menu() {
    clear

    os_info=$(grep PRETTY_NAME /etc/os-release | cut -d '=' -f2 | tr -d '"')
    pub_ip=$(curl -4 -s icanhazip.com)
    region=$(curl -s https://ipinfo.io/"$pub_ip"/region)
    [[ -z "$region" ]] && region="Unknown"
    user_total=$(total_user)
    current_host=$(get_host)
    current_time=$(date +"%H:%M:%S")

    GRAD1="\e[38;5;39m"
    GRAD2="\e[38;5;45m"
    GRAD3="\e[38;5;51m"
    MENU_NUM="\e[38;5;226m"
    MENU_TEXT="\e[38;5;15m"
    INFO_LABEL="\e[38;5;220m"
    INFO_VALUE="\e[38;5;15m"

    echo -e "${GRAD2}${BOLD}┌─────────────────────────────────────────────┐${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}🖥️ OS        :${Register} ${INFO_VALUE}${BOLD}$os_info${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}🌐 Public IP :${Register} ${INFO_VALUE}${BOLD} $pub_ip${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}📍 Region    :${Register} ${INFO_VALUE}${BOLD} $region${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}👤 Username  :${Register} ${INFO_VALUE}${BOLD} $username${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}🗓️ Expired   :${Register} ${INFO_VALUE}${BOLD}$expired${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}⏳ Sisa Hari :${Register} ${INFO_VALUE}${BOLD} $diff_days Hari${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}👥 Total User:${Register} ${INFO_VALUE}${BOLD} $user_total User${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}🌐 Host      :${Register} ${INFO_VALUE}${BOLD} $current_host${Register}"
    echo -e "${GRAD2}${BOLD}│ ${INFO_LABEL}${BOLD}🕒 Jam       :${Register} ${INFO_VALUE}${BOLD} $current_time${Register}"
    echo -e "${GRAD2}${BOLD}└─────────────────────────────────────────────┘${Register}"

    echo -e "${GRAD3}${BOLD}┌─────────────────────────────────────────────┐${Register}"
    echo -e "${GRAD3}${BOLD}│ ${MENU_NUM}${BOLD}1) ${MENU_TEXT}${BOLD}➕ Add New Users${Register}"
    echo -e "${GRAD3}${BOLD}│ ${MENU_NUM}${BOLD}2) ${MENU_TEXT}${BOLD}❌ Delete User${Register}"
    echo -e "${GRAD3}${BOLD}│ ${MENU_NUM}${BOLD}3) ${MENU_TEXT}${BOLD}🚫 Torrent Blocker${Register}"
    echo -e "${GRAD3}${BOLD}│ ${MENU_NUM}${BOLD}4) ${MENU_TEXT}${BOLD}🔄 Restart UDP Service${Register}"
    echo -e "${GRAD3}${BOLD}│ ${MENU_NUM}${BOLD}5) ${MENU_TEXT}${BOLD}⬆️ Update Scripts/System${Register}"
    echo -e "${GRAD3}${BOLD}└─────────────────────────────────────────────┘${Register}"

    echo -ne "${MENU_NUM}${BOLD}Select Operation [1-5]: ${Register}"
    read -r n

    case $n in
        1) "$SYSTEM_DIR"/Adduser.sh ;;
        2) "$SYSTEM_DIR"/DelUser.sh ;;
        3) "$SYSTEM_DIR"/torrent.sh ;;
        4)
            if systemctl restart udp-custom; then
                echo -e "${GREEN}UDP Custom restarted successfully.${Register}"
            else
                echo -e "${RED}Failed to restart UDP Custom.${Register}"
            fi
            sleep 2
            menu
            ;;
        5)
            echo -e "${YELLOW}Installing / Reinstalling scripts...${Register}"
            wget -q "https://raw.githubusercontent.com/Pemulaajiw/script/main/udp.sh" -O /tmp/udp.sh
            if [ -f /tmp/udp.sh ]; then
                chmod +x /tmp/udp.sh
                bash /tmp/udp.sh
            else
                echo -e "${RED}Failed to download install script!${Register}"
            fi
            sleep 2
            menu
            ;;
        *)
            echo -e "${RED}\nInvalid Option. Press Enter to return to the menu${Register}"
            read -r
            menu
            ;;
    esac
}

# ===== PANGGIL MENU =====
menu
